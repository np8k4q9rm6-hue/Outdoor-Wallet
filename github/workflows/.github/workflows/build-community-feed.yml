name: Build Community Events Feed

on:
  workflow_dispatch: {}
  issues:
    types:
      - labeled
      - unlabeled
      - edited
      - opened
      - closed
  schedule:
    - cron: "0 6 * * *"

permissions:
  contents: write
  issues: read

jobs:
  build-feed:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Needed so we can pull --rebase and push without non-fast-forward errors
          fetch-depth: 0

      - name: Build community-events.json from approved issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Fetch open issues labeled 'community' AND 'approved' (exclude PRs)
            const { owner, repo } = context.repo;
            const all = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state: 'open', labels: 'community,approved', per_page: 100 }
            );
            const issues = all.filter(i => !i.pull_request);

            function parseBody(body) {
              const lines = (body || '').split('\n').map(l => l.trim());

              const get = (label) => {
                const header = ('### ' + label).toLowerCase();
                const idx = lines.findIndex(l => l.toLowerCase() === header);
                if (idx >= 0) {
                  for (let i = idx + 1; i < lines.length; i++) {
                    if (lines[i] && !lines[i].startsWith('###')) return lines[i];
                  }
                }
                const kv = lines.find(l => l.toLowerCase().startsWith(label.toLowerCase() + ':'));
                if (kv) return kv.split(':').slice(1).join(':').trim();
                return '';
              };

              const title = get('Event Title');
              const date = get('Event Date/Time (ISO8601 UTC, ends with Z)') || get('Date') || get('Event Date');
              const state = get('State (Full name)') || get('State');
              const type = get('Type');
              const notes = get('Notes (optional)') || get('Notes');

              return { title, date, state, type, notes };
            }

            const events = [];
            for (const issue of issues) {
              const parsed = parseBody(issue.body || '');
              if (!parsed.title || !parsed.date || !parsed.state || !parsed.type) continue;

              // Normalize to 'hunting' or 'fishing' only
              let t = (parsed.type || '').toLowerCase();
              if (t === 'stocking') t = 'fishing';
              if (t === 'lottery') t = 'hunting';
              if (!['hunting', 'fishing'].includes(t)) continue;

              // Require timezone: 'Z' or numeric offset (e.g., -05:00)
              if (!/[Z+-]\d{2}:?\d{2}$/.test(parsed.date)) continue;

              events.push({
                title: parsed.title,
                date: parsed.date,
                state: parsed.state,
                type: t,
                notes: parsed.notes || ''
              });
            }

            // Deduplicate by title+state+type+date
            const key = e => [e.title.trim(), e.state.trim(), e.type, e.date].join('|').toLowerCase();
            const seen = new Set();
            const deduped = [];
            for (const e of events) {
              const k = key(e);
              if (!seen.has(k)) {
                seen.add(k);
                deduped.push(e);
              }
            }

            // Sort by date ascending
            deduped.sort((a, b) => a.date.localeCompare(b.date));

            fs.writeFileSync('community-events.json', JSON.stringify(deduped, null, 2) + '\n', 'utf8');
            core.info(`Wrote community-events.json with ${deduped.length} events`);

      - name: Pull, commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Ensure we're on main and up-to-date
          git checkout main
          git pull --rebase origin main

          if git status --porcelain | grep -q "community-events.json"; then
            git add community-events.json
            git commit -m "chore(feed): update community-events.json [skip ci]"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:main
          else
            echo "No changes to commit."
          fi

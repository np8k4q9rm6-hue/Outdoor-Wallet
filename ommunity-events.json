name: Mirror Community Feed to Repo

on:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours (adjust as needed)
  workflow_dispatch:         # manual trigger

permissions:
  contents: write

env:
  WORKER_URL: https://your-worker-name.your-subdomain.workers.dev/community-events.json

jobs:
  mirror-feed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Fetch approved community feed
        run: |
          set -e
          curl -fsSL "$WORKER_URL" -o community-events.json
          # Validate basic JSON shape (optional quick sanity check)
          head -c 200 community-events.json | sed 's/[^[:print:]\t]//g'
          echo
          # Ensure it's a JSON array
          test "$(jq 'type' community-events.json)" = '"array"'

      - name: Commit and push if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git status --porcelain | grep -q "community-events.json"; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add community-events.json
            git commit -m "chore(feed): mirror community-events.json from Worker [skip ci]"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }}
          else
            echo "No changes to commit."
          fi
